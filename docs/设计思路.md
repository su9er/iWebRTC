## MA的分配策略

### 说明
> * MA = MediaAgent, SGW = SignalGateway
> * MA由SGW管理和调度，每个SGW都维护了当前集群中所有MA的列表
> * MA的分配策略分为两种情况：**非级联模式**和**级联模式**

#### 非级联模式
* 在非级联模式下，一个房间的所有用户都在一个MA的相同SFU上
* 具体分配到哪个MA上，默认的策略是根据每个MA的房间数量，最少的优先分配

#### 级联模式
* 级联模式是为了应对用户分布地域差异导致的延迟问题
* 在级联模式下，SGW总是为用户分配一个网路距离最近的MA
* 级联模式下，每个用户所在的MA可能都不一样，但是每个MA只会为一个房间分配同一个SFU，也就是说，如果同一个房间的两个用户分配到了相同的MA，那么TA们肯定在同一个SFU上
* 房间级联模式的开启是在创建房间时传入参数mapolicy，设置房间是否开启SFU级联
* SGW作为网关，存储了客户端的地址信息，它将信息同步给MA，每个MA通过计算PING值，反馈到SGW

### 负载模式

#### ROOM-BEST模式
* 在ROOM-BEST模式下，根据每个MA的负载分配（优先分配最小负载的），在计算时还要考虑每个MA是否处于断链容忍状态，处于这种状态的MA，不应该参与服务
* 由于在ROOM-BEST模式下，一个房间都属于一个MA上的一个Router，如果该MA失联，可能会出现Client未主动断开与SGW的连接的情况，导致SGW上一直保存着该房间的实例。这样后续用户进入房间时，由于房间已经存在，就会继续使用该MA，必然导致服务不可用
* 解决方案：使用Client对SGW中负责管理MA的实例进行注册监听事件，当要删除一个MA时抛出事件，Client对比maid和自己当前所在的maid，如果相同，则从SGW端主动退出，关闭socket

#### TTL-BEST模式
* TTL-BEST模式下，根据每个MA的PING值进行分配（优先分配PING值最小的）。由于会测试PING值，对于断连的MA本身就不会收到回复，自然不会参与服务



## SC的分配策略
* MA = MediaAgent, SGW = SignalGateway, MS = MangeServer
* SWG由MS进行管理和调度，SGW在启动后到MS中注册
* 当用户申请token时，MS为用户分配一个SGW，默认的分配策略是随机的
* 同一个房间的用户一定会被分配到同一个SGW上

## SFU的分配策略
* SFU指的是Mediasoup的worker子进程，程序启动后会根据节点服务器的CPU数量启动相应数量的SFU，以实现对资源的最大化利用
* MA维护当前节点的SFU列表，当新的逻辑房间创建时，SGW请求到MA为房间分配一个SFU，MA的策略是循环分配，保证每个SFU上的房间数量均衡，但是不能保证负载均衡

## SGW <---> MA 如何保持数据的同步
> 同步主要是指room、client状态同步

### ROOM
* room在SGW的创建时机是第一个用户请求进入房间时
* room在MA的创建时机是SGW room创建的时候，每个房间都需要关联一个或者多个MA，当创建房间时首先会创建MA room
* room在SGW的删除时机是最后一个用户退出时
* room在MA的删除时机也是最后一个用户退出时，SGW在用户退出时会广播消息，通知MA删除对应的用户，当发现房间内用户为空，则删除房间

### client
* client在SGW的创建时机是token事件处理后
* client在MA的创建时机是处理用户的getRouterRtpCapabilities事件

## 限流

### MS限流
* 所有客户端在连接进系统的第一步是到MS获取token，所以MS的HTTP接口是作为第一级限流
* MS的限流分为两部分，全局的QPS限制和针对单个IP地址的QPS限制

#### 全局QPS
* 全局QPS限制整个MS集群对外的并发数量，默认数值为1000，超过1000部分直接回复错误
* 全局QPS可以开启队列，当开启队列时，对于超出1000的部分入队列

#### 单个用户QPS
* 单个用户QPS限制单个IP地址在单位时间内的请求次数，超过直接回复错误

### SGW限流
* SGW作为网关，针对SGW的限流是本地的，也就是我们只限制单个SGW的接入QPS,因为用户来连接SGW时MS已经将该用户和该SGW绑定， 为了避免SGW之间的相互影响，每个SGW的QPS计数都是存储在本地
